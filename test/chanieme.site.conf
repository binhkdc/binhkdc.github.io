# proxy_cache_path /etc/nginx/cache/chanieme.site levels=1:2 keys_zone=chanieme.site_cache:10m max_size=1g inactive=30m use_temp_path=off;
# proxy_cache_valid 200 302 30m;
# Rate limiting for login pages
limit_req_zone $binary_remote_addr zone=chanieme_login:10m rate=5r/s;

map $host $target {
    hostnames;
    default http://127.0.0.1:8212;
    chanieme.site http://127.0.0.1:8212;
    polytrack.chanieme.site http://127.0.0.1:7335;
    games76.chanieme.site http://127.0.0.1:8120;
    games76ez.chanieme.site http://127.0.0.1:8723;
}

server {
    listen 80;
    # server_name tftipados.click;
    server_name chanieme.site www.chanieme.site games76.chanieme.site games76ez.chanieme.site polytrack.chanieme.site;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.chanieme.site;

    ssl_certificate /etc/nginx/ssl/chanieme.site.pem;
    ssl_certificate_key /etc/nginx/ssl/chanieme.site.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_prefer_server_ciphers on;
    #ssl_stapling on;
    #ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 30s;
    ssl_buffer_size 1400;
    ssl_session_tickets on;
    add_header Strict-Transport-Security max-age=31536000;
    return 301 https://$host$request_uri
}

server {
    listen 443 ssl http2;
    server_name chanieme.site games76.chanieme.site games76ez.chanieme.site polytrack.chanieme.site;

    ssl_certificate /etc/nginx/ssl/chanieme.site.pem;
    ssl_certificate_key /etc/nginx/ssl/chanieme.site.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_prefer_server_ciphers on;
    #ssl_stapling on;
    #ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 30s;
    ssl_buffer_size 1400;
    ssl_session_tickets on;
    add_header Strict-Transport-Security max-age=3600;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "origin";

    proxy_hide_header X-Powered-By;

    merge_slashes off;

    access_log off;
    # access_log   /home/access.log;
    # error_log off;
    # error_log /home/error.log;

    # server_name chanieme.site games76.chanieme.site games76ez.chanieme.site polytrack.chanieme.site;

    set $skip_cache 0;

    if ($query_string != "") {
        set $skip_cache 0;
    }
    # POST requests and urls with a query string should always go to PHP
    if ($request_method = POST) {
        set $skip_cache 1;
    }
    if ($http_cookie ~* "logged_in|token" ) {
        set $skip_cache 1;
    }

    # set $target http://127.0.0.1:8212;

    # location ~ /purge(/.*) {
    #     add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
    #     add_header X-SKIP-CACHE 'SKIP';
    #     proxy_cache_purge chanieme.site_cache "$scheme$request_method$host$1";
    # }

    location ~* \.rss {
        add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
        # add_header X-SKIP-CACHE 'SKIP';
        if_modified_since off;
        expires -1;
        etag off;
        proxy_http_version 1.1;
        # Fix the It appears that your reverse proxy set up is broken error.
        proxy_read_timeout 90;
        proxy_redirect off;
        proxy_pass $target$uri$is_args$args;
    }

    location ~ ^/login {
        add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
        add_header X-SKIP-CACHE 'SKIP';
        proxy_buffering on;
        limit_req zone=chanieme_login burst=3 nodelay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # add_header Last-Modified $date_gmt;
        # if_modified_since off;
        # expires -1;
        # etag off;
        proxy_http_version 1.1;
        # Fix the It appears that your reverse proxy set up is broken error.
        proxy_pass $target$uri$is_args$args;
    }

    # location ~ ^/(?:id|es)/login {
    #     add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
    #     add_header X-SKIP-CACHE 'SKIP_LANG_LOGIN';
    #     proxy_buffering on;
    #     limit_req zone=chanieme.site_login burst=3 nodelay;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     # add_header Last-Modified $date_gmt;
    #     # if_modified_since off;
    #     # expires -1;
    #     # etag off;
    #     proxy_http_version 1.1;
    #     # Fix the It appears that your reverse proxy set up is broken error.
    #     proxy_pass $target$uri$is_args$args;
    # }

    location ~ ^/(?:register|logout|account|auth) {
        add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
        add_header X-SKIP-CACHE 'SKIP';
        proxy_buffering on;
        limit_req zone=chanieme_login burst=3 nodelay;
        #set $target http://45.33.111.52:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_hide_header X-Powered-By;
        add_header X-AVBC 'Yes';
        add_header Last-Modified $date_gmt;
        if_modified_since off;
        expires -1;
        etag off;
        proxy_http_version 1.1;
        # Fix the It appears that your reverse proxy set up is broken error.
        proxy_read_timeout 90;
        proxy_redirect off;
        proxy_pass $target$uri$is_args$args;
    }

    # location ~ ^/id/(?:register|logout|account|auth) {
    #     add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
    #     add_header X-SKIP-CACHE 'SKIP';
    #     proxy_buffering on;
    #     limit_req zone=chanieme.site_login burst=3 nodelay;
    #     #set $target http://45.33.111.52:8080;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_hide_header X-Powered-By;
    #     add_header X-AVBC 'Yes';
    #     add_header Last-Modified $date_gmt;
    #     expires -1;
    #     etag off;
    #     proxy_http_version 1.1;
    #     # Fix the It appears that your reverse proxy set up is broken error.
    #     proxy_read_timeout 90;
    #     proxy_redirect off;
    #     proxy_pass $target$uri$is_args$args;
    # }

    location ~ ^/admin/post/post-game/uploadsource {
        client_max_body_size 1024M;  
        client_body_timeout 300s;     
        client_body_buffer_size 16M;  
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;      
        proxy_connect_timeout 300;    
        proxy_pass $target$uri$is_args$args;
    }

    location ~ ^/(admin|getapk|logout|suggest) {
        add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
        add_header X-SKIP-CACHE 'SKIP';
        add_header Last-Modified $date_gmt;
        if_modified_since off;
        expires -1;
        etag off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_hide_header X-Powered-By;
        proxy_http_version 1.1;
        # Fix the It appears that your reverse proxy set up is broken error.
        proxy_read_timeout 90;
        proxy_redirect off;
        proxy_pass $target$uri$is_args$args;
    }

    location ~ ^/(.+\.(?:jpe?g|png))$ {
        proxy_cache_key "$scheme$request_method$host$request_uri";
        # proxy_cache chanieme.site_cache;
        proxy_cache_revalidate on;
        proxy_cache_lock on;
        proxy_buffering on;
        add_header X-Cache-Status $upstream_cache_status;

        expires 30d;
        #     add_header Cache-Control "public, must-revalidate, proxy-revalidate";
        proxy_ignore_headers Expires Cache-Control Set-Cookie Vary;
        proxy_hide_header Set-Cookie;
        proxy_set_header Cookie "";
        proxy_set_header Host $http_host;
        proxy_hide_header X-Powered-By;
        proxy_pass $target$uri$is_args$args;
        #        proxy_pass http://127.0.0.1:3333;
    }

    # location ~ ^/uploads {
    #     proxy_cache_key "$scheme$request_method$host$request_uri";
    #     proxy_cache chanieme.site_cache;
    #     proxy_cache_revalidate on;
    #     proxy_cache_lock on;
    #     proxy_buffering on;
    #     add_header Cache-Control 'public, max-age=2592000';
    #     proxy_hide_header X-Powered-By;
    #     #proxy_cache_bypass $skip_cache;
    #     proxy_ignore_headers Expires Cache-Control Set-Cookie Vary;
    #     proxy_hide_header Set-Cookie;
    #     #proxy_set_header  Cookie "";
    #     add_header X-Cache-Status $upstream_cache_status;
    #     proxy_pass $target$uri$is_args$args;
    # }

    # file tinh
    #https://serverfault.com/a/504722
    ## for the rest of the pages, excluding locations beginning
    ## with /<2char-lang-prefix>/*
    ## also excludes locations having only 3 characters, e.g. "/nb"
    location ~* .(gif|jpg|jpeg|png|ico|wmv|3gp|avi|mpg|mpeg|mp4|flv|mp3|mid|js|css|txt|woff)$ {
        expires 30d;
        proxy_set_header Host $http_host;
        add_header X-Cache-Status $upstream_cache_status;
        proxy_pass $target$uri$is_args$args;
    }

    location ~* .(xml|xsl|xsl)$ {
        add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
        add_header Last-Modified $date_gmt;
        if_modified_since off;
        expires -1;
        etag off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Dashboard 'x-dashboard';
        proxy_hide_header X-Powered-By;
        proxy_http_version 1.1;
        # Fix the It appears that your reverse proxy set up is broken error.
        proxy_read_timeout 90;
        proxy_redirect off;
        proxy_pass $target$uri$is_args$args;
    }

    location / {
        if ($args ~ '\bxclear[=&]?' ) {
            set $skip_cache 1;
        }
        proxy_cache_key "$scheme$request_method$host$request_uri";
        # proxy_cache chanieme.site_cache;
        proxy_cache_revalidate on;
        proxy_cache_lock on;
        proxy_buffering on;
        proxy_set_header If-Modified-Since $http_if_modified_since;
        add_header Cache-Control 'public, max-age=3600';
        proxy_cache_use_stale error
        timeout
        updating
        http_500
        http_502
        http_503
        http_504;

        proxy_hide_header X-Powered-By;

        proxy_ignore_headers Expires Cache-Control Set-Cookie Vary;
        proxy_hide_header Set-Cookie;
        #proxy_set_header  Cookie "";

        # Security headers
        add_header X-Mobi modcomboio;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        if ($args ~ '\bxclear[=&]?' ) {
            add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Mobi domain;
            add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
        }
        if ( $skip_cache = 1 ) {
            add_header Cache-Control 'no-cache, must-revalidate, proxy-revalidate, max-age=0';
            add_header X-SKIP-CACHE 'SKIP-ALL';
        }
        proxy_cache_bypass $skip_cache;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-NginX-Proxy true;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;

        add_header X-http_upgrade $http_upgrade;
        proxy_http_version 1.1;
        # Fix the It appears that your reverse proxy set up is broken error.
        proxy_read_timeout 90;
        proxy_redirect off;

        #redirect trang chu
        # if ($args ~* "s=(.*)"){
        # 	proxy_pass $target$uri$is_args$args;
        # 	break;
        # }

        # if ( $uri = / ) {
        #     return 301 /ar$uri;
        # }
        proxy_pass $target$uri$is_args$args;

        # 504 Gateway Time-out
        error_page 502 504 = @backend_down;
    }

    # location ~* "^/(?!.{2,2}/).{3}.*$" {
    #     rewrite "^/(.*)$" /id/$1 permanent;
    # }
    location @backend_down {
        proxy_pass http://$target$uri$is_args$args;
    }


}

